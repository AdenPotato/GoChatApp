<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - GoChatApp</title>
</head>
<body>
    <h1>Chat Room</h1>

    <div id="userInfo">
        <p>Logged in as: <strong id="currentUser"></strong></p>
        <button id="logoutBtn">Logout</button>
    </div>

    <hr>

    <div style="display: flex; gap: 20px;">
        <div id="roomsContainer" style="width: 200px;">
            <h3>Rooms</h3>
            <div id="roomsList" style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>
            <form id="createRoomForm">
                <input type="text" id="newRoomName" placeholder="Room name" required style="width: 100%; margin-bottom: 5px;">
                <button type="submit" style="width: 100%;">Create Room</button>
            </form>
        </div>

        <div id="chatContainer" style="flex: 1;">
            <h2>Messages <span id="currentRoomName">(Global)</span></h2>
            <div id="messages" style="border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin-bottom: 10px;">
                <p><em>Loading messages...</em></p>
            </div>

            <form id="messageForm">
                <input type="text" id="messageInput" placeholder="Type a message..." required style="width: 80%;">
                <button type="submit">Send</button>
            </form>
        </div>

        <div id="usersContainer" style="width: 150px;">
            <h3>Users</h3>
            <ul id="usersList"></ul>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // Redirect to login if not authenticated
        if (!token || !user.id) {
            window.location.href = '/static/login.html';
        }

        // Display current user
        document.getElementById('currentUser').textContent = user.username || 'Unknown';

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (ws) {
                ws.close();
            }
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/static/login.html';
        });

        // Current room tracking
        let currentRoomId = null;

        // WebSocket connection
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connectWebSocket() {
            const wsUrl = `ws://${window.location.host}/api/ws?token=${encodeURIComponent(token)}`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
                addSystemMessage('Connected to chat');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                addSystemMessage('Disconnected from chat');
                attemptReconnect();
            };
        }

        function attemptReconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log(`Attempting to reconnect... (${reconnectAttempts}/${maxReconnectAttempts})`);
                setTimeout(connectWebSocket, 2000 * reconnectAttempts);
            } else {
                addSystemMessage('Failed to reconnect. Please refresh the page.');
            }
        }

        function handleWebSocketMessage(data) {
            const messagesDiv = document.getElementById('messages');

            switch(data.type) {
                case 'message':
                case 'chat':
                    // Only show messages for current room (or global if no room)
                    if (data.room_id === currentRoomId || (!data.room_id && !currentRoomId)) {
                        addMessage(data.username, data.content, data.timestamp);
                    }
                    break;
                case 'user_joined':
                    // Only show global join/leave when in global chat
                    if (!currentRoomId) {
                        addSystemMessage(`${data.username} joined the chat`);
                    }
                    break;
                case 'user_left':
                    if (!currentRoomId) {
                        addSystemMessage(`${data.username} left the chat`);
                    }
                    break;
                case 'room_user_joined':
                    if (data.room_id === currentRoomId) {
                        addSystemMessage(`${data.username} joined the room`);
                    }
                    break;
                case 'room_user_left':
                    if (data.room_id === currentRoomId) {
                        addSystemMessage(`${data.username} left the room`);
                    }
                    break;
                default:
                    console.log('Unknown message type:', data);
            }

            // Auto-scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessage(username, content, timestamp) {
            const messagesDiv = document.getElementById('messages');
            const messageEl = document.createElement('div');
            const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();

            const isOwnMessage = username === user.username;
            messageEl.style.textAlign = isOwnMessage ? 'right' : 'left';
            messageEl.style.margin = '5px 0';

            messageEl.innerHTML = `<strong>${username}:</strong> ${content} <em style="font-size: 0.8em; color: #666;">(${time})</em>`;
            messagesDiv.appendChild(messageEl);
        }

        function addSystemMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.style.textAlign = 'center';
            messageEl.style.color = '#666';
            messageEl.style.fontStyle = 'italic';
            messageEl.style.margin = '10px 0';
            messageEl.textContent = message;
            messagesDiv.appendChild(messageEl);
        }

        // Load initial messages from API
        async function loadMessages() {
            try {
                const response = await fetch('/api/messages', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const data = await response.json();
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = ''; // Clear loading message

                if (response.ok && data.messages && data.messages.length > 0) {
                    data.messages.reverse().forEach(msg => {
                        addMessage(msg.user?.username || 'Unknown', msg.content, msg.created_at);
                    });
                } else {
                    addSystemMessage('No previous messages');
                }

                // Auto-scroll to bottom
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
                addSystemMessage('Error loading messages');
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                const usersList = document.getElementById('usersList');

                if (response.ok && data.users && data.users.length > 0) {
                    usersList.innerHTML = '';
                    data.users.forEach(u => {
                        const li = document.createElement('li');
                        li.textContent = u.username;
                        if (u.id === user.id) {
                            li.textContent += ' (you)';
                            li.style.fontWeight = 'bold';
                        }
                        usersList.appendChild(li);
                    });
                } else {
                    usersList.innerHTML = '<li><em>No users</em></li>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Send message via WebSocket
        document.getElementById('messageForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const content = document.getElementById('messageInput').value.trim();

            if (!content) {
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'chat',
                    content: content
                };
                if (currentRoomId) {
                    message.room_id = currentRoomId;
                }
                ws.send(JSON.stringify(message));
                document.getElementById('messageInput').value = '';
            } else {
                addSystemMessage('Cannot send message: Not connected');
            }
        });

        // Load rooms
        async function loadRooms() {
            try {
                const response = await fetch('/api/rooms');
                const data = await response.json();
                const roomsList = document.getElementById('roomsList');

                roomsList.innerHTML = '';

                // Add global chat option
                const globalBtn = document.createElement('button');
                globalBtn.textContent = 'Global Chat';
                globalBtn.style.cssText = 'width: 100%; margin-bottom: 5px; padding: 5px;';
                globalBtn.onclick = () => switchRoom(null, 'Global');
                if (!currentRoomId) {
                    globalBtn.style.fontWeight = 'bold';
                    globalBtn.style.backgroundColor = '#ddd';
                }
                roomsList.appendChild(globalBtn);

                if (response.ok && data.rooms && data.rooms.length > 0) {
                    data.rooms.forEach(room => {
                        const roomBtn = document.createElement('button');
                        roomBtn.textContent = room.name;
                        roomBtn.style.cssText = 'width: 100%; margin-bottom: 5px; padding: 5px;';
                        roomBtn.onclick = () => switchRoom(room.id, room.name);
                        if (currentRoomId === room.id) {
                            roomBtn.style.fontWeight = 'bold';
                            roomBtn.style.backgroundColor = '#ddd';
                        }
                        roomsList.appendChild(roomBtn);
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }

        // Switch to a room
        function switchRoom(roomId, roomName) {
            // Leave current room if in one
            if (currentRoomId && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'leave_room', room_id: currentRoomId }));
            }

            currentRoomId = roomId;
            document.getElementById('currentRoomName').textContent = `(${roomName})`;
            document.getElementById('messages').innerHTML = '';

            // Join new room if not global
            if (roomId && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'join_room', room_id: roomId }));
            }

            addSystemMessage(`Switched to ${roomName}`);
            loadRooms(); // Refresh room list to update highlighting
        }

        // Create room
        document.getElementById('createRoomForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const roomName = document.getElementById('newRoomName').value.trim();
            if (!roomName) return;

            try {
                const response = await fetch('/api/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ name: roomName })
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('newRoomName').value = '';
                    loadRooms();
                    // Switch to the new room
                    switchRoom(data.room.id, data.room.name);
                } else {
                    alert('Error: ' + (data.error || 'Failed to create room'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Initialize
        loadMessages();
        loadUsers();
        loadRooms();
        connectWebSocket();
    </script>
</body>
</html>
